<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=no">
    <title>Mapa con OpenStreetMap, KML y KMZ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        #map {
            width: 100%;
            height: 100vh;
        }
        #toggle-kml {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            font-size: 55px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease;
        }
        #toggle-kml:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <button id="toggle-kml">Mostrar/Ocultar Zona de Inundaciones</button>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js"></script>
    <script>
        var map = L.map('map', {
            zoomAnimation: false
        }).setView([20.675556, -103.385833], 15);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        var rainMarkers = [];
        var zoomThreshold = 17; 
        var minIconSize = 350;
        var maxIconSize = 450;
        var kmlLayerInundaciones = null;

        // Función para agregar un ícono de lluvia
        function addRainIcon(coord, intensity) {
            var iconUrl, iconStaticUrl;
            
            if (intensity === "ligera") {
                iconUrl = './complements/gifs/rainy.gif';
                iconStaticUrl = './complements/gifs/rainy_static.png';
            } else {
                iconUrl = './complements/gifs/lluvias.gif';
                iconStaticUrl = './complements/gifs/lluvias_static.png';
            }

            var currentZoom = map.getZoom();
            var iconSrc = currentZoom >= zoomThreshold ? iconUrl : iconStaticUrl;

            var rainIcon = L.icon({
                iconUrl: iconSrc,
                iconSize: [maxIconSize, maxIconSize],
                iconAnchor: [maxIconSize / 2, maxIconSize / 2]
            });

            var marker = L.marker(coord, { icon: rainIcon }).addTo(map);
            rainMarkers.push(marker);
        }

        function resizeRainIcons() {
            var currentZoom = map.getZoom();
            var iconSize = Math.max(minIconSize, Math.min(maxIconSize, currentZoom * 10));

            rainMarkers.forEach(function(marker) {
                var icon = marker.options.icon;
                var iconSrc = currentZoom >= zoomThreshold ? icon.options.iconUrl.replace('_static.png', '.gif') : icon.options.iconUrl.replace('.gif', '_static.png');
                
                icon.options.iconUrl = iconSrc;
                icon.options.iconSize = [iconSize, iconSize];
                marker.setIcon(icon);
            });
        }

        var userMarker = null;

        // Función para crear el marcador de usuario y permitir que sea arrastrable
        function createUserMarker(lat, lng) {
            if (!userMarker) {
                var largeIcon = L.icon({
                    iconUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon.png',
                    iconSize: [90, 140],
                    iconAnchor: [40, 130],
                    popupAnchor: [0, -120]
                });

                userMarker = L.marker([lat, lng], { icon: largeIcon, draggable: true }).addTo(map)
                    .bindPopup('<div style="font-size: 20px; font-weight: bold;">Tu ubicación</div>')
                    .openPopup();

                // Escuchar el evento de arrastre del marcador
                userMarker.on('dragend', function(event) {
                    var newPos = event.target.getLatLng();
                    updateLocationOnDrag(newPos.lat, newPos.lng); // Notificar la nueva ubicación
                });
            } else {
                userMarker.setLatLng([lat, lng]);
            }

            map.setView([lat, lng], 15, { animate: true });
        }

        // Función que recibe la ubicación desde la app móvil
        window.updateUserLocation = function(lat, lng) {
            createUserMarker(lat, lng); 
            checkIfInZone(lat, lng);    
        };

        // Notificar la app cuando el marcador de usuario se arrastra
        function updateLocationOnDrag(lat, lng) {
            createUserMarker(lat, lng); // Actualizar el marcador
            checkIfInZone(lat, lng);    // Verificar las condiciones para la nueva ubicación

            // Enviar la nueva ubicación a la app móvil
            window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));
        }

        function checkIfInZone(lat, lng) {
            var point = L.latLng(lat, lng);
            var inFloodZone = false;

            polygons.forEach(function(polygon) {
                if (polygon.getBounds().contains(point)) {
                    inFloodZone = true;
                }
            });

            window.ReactNativeWebView.postMessage(JSON.stringify({ inFloodZone }));
        }

        document.getElementById("toggle-kml").addEventListener('click', function() {
            if (kmlLayerInundaciones) {
                if (map.hasLayer(kmlLayerInundaciones)) {
                    map.removeLayer(kmlLayerInundaciones);
                } else {
                    map.addLayer(kmlLayerInundaciones);
                }
            } else {
                kmlLayerInundaciones = omnivore.kml('./kmls/inundaciones.kml').addTo(map);
            }
        });

        map.on('zoomend', function() {
            resizeRainIcons();
        });

        omnivore.kml('./kmls/lluvias_areas.kml').on('ready', function() {
            this.eachLayer(function(layer) {
                var center = layer.getBounds().getCenter();
                addRainIcon(center, "fuerte");
            });
            resizeRainIcons();
        });
    </script>
</body>
</html>
